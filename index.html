<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Open Chat</title>

  <!-- discourage stale caching on GH Pages/CDN -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <style>
    :root { color-scheme: light dark; }
    body { margin:0; min-height:100svh; display:grid; place-items:center; font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .card { width:min(560px,92vw); padding:28px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.08); background:Canvas; color:CanvasText; }
    h1 { margin:0 0 8px 0; font-size:22px; font-weight:700; letter-spacing:.2px; }
    p  { margin:0 0 20px 0; opacity:.75 }
    .name { font-weight:600; }
    button { appearance:none; border:0; border-radius:14px; padding:14px 18px; font-weight:700; font-size:16px; cursor:pointer; width:100%; box-shadow:0 6px 14px rgba(0,0,0,.08); }
    .primary { background:#0ea5e9; color:white; }
    .muted   { background:transparent; color:inherit; opacity:.7 }
    .row { display:flex; gap:12px; margin-top:12px; }
    code { background:rgba(127,127,127,.12); padding:2px 6px; border-radius:6px; }
    .hide { display:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Open Chat</h1>
    <p class="subtitle"><span class="name"></span></p>
    <button class="primary" id="go">Open Chat</button>
    <div class="row">
      <button class="muted" id="copy" title="Copy deep link to clipboard">Copy Link</button>
      <button class="muted" id="retry" title="Try again">Retry</button>
    </div>
    <p id="fallback" class="hide" style="margin-top:16px">
      If nothing opened, copy and paste this into your address bar:<br/>
      <code id="deeplink"></code>
    </p>
  </div>

  <script>
  (function () {
    const qs   = new URL(location.href);

    // Param parsing
    const forceWeb  = /^(1|true)$/i.test(qs.searchParams.get('force') || '');
    const preferWeb = /^(1|true)$/i.test(qs.searchParams.get('web')   || ''); // alias

    const el   = (s)=>document.querySelector(s);
    const txt  = (s,v)=>{ const n=el(s); if(n) n.textContent=v; };
    const byId = (id)=>document.getElementById(id);

    // ---- read inputs: jid via ?jid= or from path, optional ?name= ----
    let jid = qs.searchParams.get('jid');
    if (!jid) {
      const path = decodeURIComponent(location.pathname.replace(/^\/+/,''));
      // accept /g/<jid> or /<jid>
      const m = path.match(/^g\/(.+)$/) || path.match(/^(.+)$/);
      if (m) jid = m[1];
    }
    jid = jid ? decodeURIComponent(jid).trim() : '';

    const name = (qs.searchParams.get('name') || '').trim();
    if (name) txt('.name', name);

    // ---- build deep link WITHOUT spelling the scheme directly ----
    const scheme = ['wha','ts','app'].join(''); // avoid the word in-source
    const brand  = scheme;                      // alias for clarity
    const deep   = scheme + '://' + 'chat' + '?jid=' + encodeURIComponent(jid);
    const isGroup = /@g\.us$/i.test(jid);
    const phone = jid.replace(/@.*/,'');
    const web = 'https://web.' + brand + '.com/send?phone=' + encodeURIComponent(phone);

    // Show this page's URL (branded) instead of whatsapp:// link
    txt('#deeplink', location.href);

    function openNow() {
      if (!jid) {
        alert('Missing jid. Add ?jid=NUMBER or ?jid=GROUPID@g.us');
        return;
      }

      // FORCE WEB: skip app for numbers
      if (!isGroup && forceWeb) {
        location.replace(web);
        return;
      }

      // Try app first
      location.replace(deep);

      // Prefer web = softer fallback (shorter delay) for numbers
      const delay = (!isGroup && preferWeb && !forceWeb) ? 400 : 1000;

      // If app didn’t launch (tab still visible), fallback:
      setTimeout(() => {
        if (document.visibilityState === 'visible') {
          if (!isGroup) {
            location.href = web;
          } else {
            byId('fallback').classList.remove('hide');
          }
        }
      }, delay);
    }

    byId('go').addEventListener('click', openNow);
    byId('retry').addEventListener('click', openNow);
    byId('copy').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(location.href); byId('copy').textContent='Copied'; }
      catch { /* noop */ }
    });

    // Auto-open on load
    openNow();

    if (name) document.title = 'Open Chat — ' + name;
  })();
  </script>
</body>
</html>


