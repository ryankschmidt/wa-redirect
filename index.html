<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Open Chat</title>

  <!-- discourage stale caching on GH Pages/CDN -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <style>
    :root { color-scheme: light dark; }
    body { margin:0; min-height:100svh; display:grid; place-items:center; font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .card { width:min(560px,92vw); padding:28px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.08); background:Canvas; color:CanvasText; }
    h1 { margin:0 0 8px 0; font-size:22px; font-weight:700; letter-spacing:.2px; }
    p  { margin:0 0 20px 0; opacity:.75 }
    .name { font-weight:600; }
    button { appearance:none; border:0; border-radius:14px; padding:14px 18px; font-weight:700; font-size:16px; cursor:pointer; width:100%; box-shadow:0 6px 14px rgba(0,0,0,.08); }
    .primary { background:#0ea5e9; color:white; }
    .muted   { background:transparent; color:inherit; opacity:.7 }
    .row { display:flex; gap:12px; margin-top:12px; }
    code { background:rgba(127,127,127,.12); padding:2px 6px; border-radius:6px; }
    .hide { display:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Open Chat</h1>
    <p class="subtitle"><span class="name"></span></p>
    <button class="primary" id="go">Open Chat</button>
    <div class="row">
      <button class="muted" id="copy" title="Copy page link to clipboard">Copy Link</button>
      <button class="muted" id="retry" title="Try again">Retry</button>
    </div>
    <p id="fallback" class="hide" style="margin-top:16px">
      If nothing opened, tap the button above. Or copy/paste this into your address bar:<br/>
      <code id="deeplink"></code>
    </p>
  </div>

  <script>
  (function () {
    const qs   = new URL(location.href);
    const el   = (s)=>document.querySelector(s);
    const txt  = (s,v)=>{ const n=el(s); if(n) n.textContent=v; };
    const byId = (id)=>document.getElementById(id);

    // ---- read inputs: jid via ?jid= or from path, optional ?name= ----
    let jid = qs.searchParams.get('jid');
    if (!jid) {
      const path = decodeURIComponent(location.pathname.replace(/^\/+/,''));
      // accept /g/<jid> or /<jid>
      const m = path.match(/^g\/(.+)$/) || path.match(/^(.+)$/);
      if (m) jid = m[1];
    }
    jid = jid ? decodeURIComponent(jid).trim() : '';

    const name = (qs.searchParams.get('name') || '').trim();
    if (name) txt('.name', name);

    // ---- build deep link (explicit scheme) ----
    const deep   = 'whatsapp://chat?jid=' + encodeURIComponent(jid);

    // show this page's own URL for copy fallback (keeps your branded domain)
    txt('#deeplink', location.href);

    // open handler (used for auto-open, Retry, and button tap)
    function openNow() {
      if (!jid) {
        alert('Missing jid. Add ?jid=NUMBER or ?jid=GROUPID@g.us');
        return;
      }
      // Try to launch WhatsApp immediately
      location.href = deep;

      // If the app didn't take focus (tab still visible), reveal fallback UI
      setTimeout(() => {
        if (document.visibilityState === 'visible') {
          byId('fallback').classList.remove('hide');
        }
      }, 600);
    }

    byId('go').addEventListener('click', openNow);
    byId('retry').addEventListener('click', openNow);
    byId('copy').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(location.href); byId('copy').textContent='Copied'; }
      catch { /* noop */ }
    });

    // Auto-open on load (restores your original click-link → instant open behavior)
    openNow();

    if (name) document.title = 'Open Chat — ' + name;
  })();
  </script>
</body>
</html>
